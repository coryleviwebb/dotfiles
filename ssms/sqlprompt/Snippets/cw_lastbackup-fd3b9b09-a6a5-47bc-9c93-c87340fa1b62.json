{
  "id": "fd3b9b09-a6a5-47bc-9c93-c87340fa1b62",
  "prefix": "cw_lastbackup",
  "description": "Gets the last backup date by database",
  "body": "-- Last backup information by database  (Query 8) (Last Backup By Database)\r\nSELECT ISNULL(d.[name], bs.[database_name]) AS [Database], d.recovery_model_desc AS [Recovery Model], \r\n    d.log_reuse_wait_desc AS [Log Reuse Wait Desc],\r\n\tCONVERT(DECIMAL(18,2), ds.cntr_value/1024.0) AS [Total Data File Size on Disk (MB)],\r\n\tCONVERT(DECIMAL(18,2), ls.cntr_value/1024.0) AS [Total Log File Size on Disk (MB)], \r\n\tCAST(CAST(lu.cntr_value AS FLOAT) / CAST(ls.cntr_value AS FLOAT) AS DECIMAL(18,2)) * 100 AS [Log Used %],\r\n    MAX(CASE WHEN bs.[type] = 'D' THEN bs.backup_finish_date ELSE NULL END) AS [Last Full Backup],\r\n\tMAX(CASE WHEN bs.[type] = 'D' THEN CONVERT (BIGINT, bs.compressed_backup_size / 1048576 ) ELSE NULL END) AS [Last Full Compressed Backup Size (MB)],\r\n\tMAX(CASE WHEN bs.[type] = 'D' THEN CONVERT (DECIMAL(18,2), bs.backup_size /bs.compressed_backup_size ) ELSE NULL END) AS [Backup Compression Ratio],\r\n    MAX(CASE WHEN bs.[type] = 'I' THEN bs.backup_finish_date ELSE NULL END) AS [Last Differential Backup],\r\n    MAX(CASE WHEN bs.[type] = 'L' THEN bs.backup_finish_date ELSE NULL END) AS [Last Log Backup],\r\n\tDATABASEPROPERTYEX ((d.[name]), 'LastGoodCheckDbTime') AS [Last Good CheckDB]\r\nFROM sys.databases AS d WITH (NOLOCK)\r\nINNER JOIN sys.master_files as mf WITH (NOLOCK)\r\nON d.database_id = mf.database_id\r\nLEFT OUTER JOIN msdb.dbo.backupset AS bs WITH (NOLOCK)\r\nON bs.[database_name] = d.[name]\r\nAND bs.backup_finish_date > GETDATE()- 30\r\nLEFT OUTER JOIN sys.dm_os_performance_counters AS lu WITH (NOLOCK)\r\nON d.name = lu.instance_name\r\nLEFT OUTER JOIN sys.dm_os_performance_counters AS ls WITH (NOLOCK)\r\nON d.name = ls.instance_name\r\nINNER JOIN sys.dm_os_performance_counters AS ds WITH (NOLOCK)\r\nON d.name = ds.instance_name\r\nWHERE d.name <> N'tempdb'\r\nAND lu.counter_name LIKE N'Log File(s) Used Size (KB)%' \r\nAND ls.counter_name LIKE N'Log File(s) Size (KB)%'\r\nAND ds.counter_name LIKE N'Data File(s) Size (KB)%'\r\nAND ls.cntr_value > 0 \r\nGROUP BY ISNULL(d.[name], bs.[database_name]), d.recovery_model_desc, d.log_reuse_wait_desc, d.[name],\r\n         CONVERT(DECIMAL(18,2), ds.cntr_value/1024.0),\r\n\t     CONVERT(DECIMAL(18,2), ls.cntr_value/1024.0), \r\n         CAST(CAST(lu.cntr_value AS FLOAT) / CAST(ls.cntr_value AS FLOAT) AS DECIMAL(18,2)) * 100\r\nORDER BY d.recovery_model_desc, d.[name] OPTION (RECOMPILE);"
}
{
  "id": "ca1c2dda-e053-4b46-b749-27bc79b4fb7d",
  "prefix": "cw_cpuhistory",
  "description": "",
  "body": "-- Get CPU Utilization History for last 256 minutes (in one minute intervals)  (Query 47) (CPU Utilization History)\r\nDECLARE @ts_now bigint = (SELECT ms_ticks FROM sys.dm_os_sys_info WITH (NOLOCK)); \r\n\r\nSELECT TOP(256) SQLProcessUtilization AS [SQL Server Process CPU Utilization], \r\n               SystemIdle AS [System Idle Process], \r\n               100 - SystemIdle - SQLProcessUtilization AS [Other Process CPU Utilization], \r\n               DATEADD(ms, -1 * (@ts_now - [timestamp]), GETDATE()) AS [Event Time] \r\nFROM (SELECT record.value('(./Record/@id)[1]', 'int') AS record_id, \r\n              record.value('(./Record/SchedulerMonitorEvent/SystemHealth/SystemIdle)[1]', 'int') \r\n                      AS [SystemIdle], \r\n              record.value('(./Record/SchedulerMonitorEvent/SystemHealth/ProcessUtilization)[1]', 'int') \r\n                      AS [SQLProcessUtilization], [timestamp] \r\n         FROM (SELECT [timestamp], CONVERT(xml, record) AS [record] \r\n                      FROM sys.dm_os_ring_buffers WITH (NOLOCK)\r\n                      WHERE ring_buffer_type = N'RING_BUFFER_SCHEDULER_MONITOR' \r\n                      AND record LIKE N'%<SystemHealth>%') AS x) AS y \r\nORDER BY record_id DESC OPTION (RECOMPILE);\r\n------"
}
{
  "id": "31c5baf1-ee09-4880-bdd3-78415a1734d0",
  "prefix": "cw_lastaccessdate",
  "description": "",
  "body": "SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;\r\n\r\n/*\r\nSELECT \r\n     sqlserver_start_time \r\n    ,DATEDIFF(day, sqlserver_start_time , CURRENT_TIMESTAMP)  AS UptimeDays\r\nFROM sys.dm_os_sys_info;\r\n*/\r\n\r\n/* Finds the date/time when an object was last reused since last SQL Server restart */\r\nWITH LastActivity (ObjectID, LastAction)\r\nAS\r\n(\r\n\tSELECT object_id AS TableName, Last_User_Seek as LastAction\r\n\tFROM sys.dm_db_index_usage_stats u\r\n\tWHERE database_id = db_id(db_name())\r\n\tUNION\r\n\tSELECT object_id AS TableName,last_user_scan as LastAction\r\n\tFROM sys.dm_db_index_usage_stats u\r\n\tWHERE database_id = db_id(db_name())\r\n\tUNION\r\n\tSELECT object_id AS TableName,last_user_lookup as LastAction\r\n\tFROM sys.dm_db_index_usage_stats u \r\n\tWHERE database_id = db_id(db_name())\r\n),\r\nTableSize AS\r\n(\r\n\tSELECT \r\n\t  a3.name AS [schemaname]\r\n\t  , a2.name AS [tablename]\r\n\t  , a2.create_date AS table_creation_date\r\n\t  , a1.rows AS row_count\r\n\t  , (a1.reserved + isnull(a4.reserved, 0)) * 8 AS reserved\r\n\t  , a1.data * 8 AS data\r\n\t  , (CASE WHEN (a1.used + isnull(a4.used, 0)) > a1.data THEN (a1.used + isnull(a4.used, 0)) - a1.data \r\n\t\tELSE 0 END) * 8 AS index_size\r\n\t  , (CASE\r\n\t\t\tWHEN (a1.reserved + isnull(a4.reserved, 0)) > a1.used THEN (a1.reserved + isnull(a4.reserved, 0)) - a1.used\r\n\t\t\tELSE 0 END) * 8 AS unused\r\n\tFROM\r\n\t\t(SELECT\r\n\t\t\t ps.object_id\r\n\t\t   , sum(CASE WHEN (ps.index_id < 2) THEN row_count ELSE 0 END) AS [rows]\r\n\t\t   , sum(ps.reserved_page_count) AS reserved\r\n\t\t   , sum(CASE WHEN (ps.index_id < 2) THEN (ps.in_row_data_page_count + ps.lob_used_page_count + ps.row_overflow_used_page_count)\r\n\t\t\t\t ELSE (ps.lob_used_page_count + ps.row_overflow_used_page_count) END) AS data\r\n\t\t   , sum(ps.used_page_count) AS used\r\n\t\t FROM sys.dm_db_partition_stats ps\r\n\t\t GROUP BY ps.object_id) AS a1\r\n\t\tLEFT OUTER JOIN (SELECT\r\n\t\t\t\t\t\t\t it.parent_id\r\n\t\t\t\t\t\t   , sum(ps.reserved_page_count) AS reserved\r\n\t\t\t\t\t\t   , sum(ps.used_page_count) AS used\r\n\t\t\t\t\t\t FROM\r\n\t\t\t\t\t\t\t sys.dm_db_partition_stats ps INNER JOIN sys.internal_tables it ON (it.object_id = ps.object_id)\r\n\t\t\t\t\t\t WHERE it.internal_type IN (202, 204)\r\n\t\t\t\t\t\t GROUP BY\r\n\t\t\t\t\t\t\t it.parent_id) AS a4\r\n\t\t\tON (a4.parent_id = a1.object_id)\r\n\t\tINNER JOIN sys.all_objects a2 ON (a1.object_id = a2.object_id)\r\n\t\tINNER JOIN sys.schemas a3 ON (a2.schema_id = a3.schema_id)\r\n\tWHERE\r\n\t\ta2.type <> N'S'\tAND a2.type <> N'IT'\r\n)\r\nSELECT \r\n\tT.tablename,\r\n\tCAST(T.table_creation_date AS DATE) AS table_creation_date,\r\n\tMAX(la.LastAction) AS LastSelect,\r\n\tISNULL(datediff(day, max(la.LastAction), getdate()), -1) AS DaysAgoLastSelect,\r\n\tT.row_count, \r\n\tT.reserved / 1024 AS [Reserved (MB)], \r\n\tT.data / 1024 AS [Data (MB)], \r\n\tT.index_size/ 1024 AS [Index Size (MB)], \r\n\tT.unused / 1024 AS [Unused (MB)]\r\nFROM\r\n\tsys.objects so LEFT JOIN LastActivity la ON so.object_id = la.ObjectID \r\n\tINNER JOIN TableSize T ON OBJECT_NAME(so.object_id) = tablename\r\nWHERE so.type = 'U' AND so.is_ms_shipped = 0\r\nGROUP BY T.tablename, T.row_count, T.reserved, T.data, T.index_size, T.unused, CAST(T.table_creation_date AS DATE)\r\nORDER BY DaysAgoLastSelect, [Reserved (MB)] DESC"
}